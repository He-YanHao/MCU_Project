#include "touch.h"
#include "stdio.h"
#include "string.h"
#include "lcd.h"

_m_tp_dev tp_dev;

const uint16_t FT5206_TPX_TBL[5] = {FT_TP1_REG, FT_TP2_REG, FT_TP3_REG, FT_TP4_REG, FT_TP5_REG};
uint8_t g_gt_tnum = 5; // ????????????????(5????)

//#define ACTIVE_WIDTH 480
//#define ACTIVE_HEIGHT 800

void touch_delay_1us(uint16_t us)
{
    while (us--)
    {
        __NOP();
        __NOP();
        __NOP();
        __NOP();
        __NOP();
        __NOP();
    }
}

// ????I2C???????
void CT_Delay(void)
{
    touch_delay_1us(2);
}

// ???????§à?IIC???????
void CT_IIC_Init(void)
{
    /* enable the led clock */
    rcu_periph_clock_enable(SCL_RCU);
    /* configure led GPIO port */
    gpio_mode_set(SCL_PORT, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLUP, SCL_PIN);
    gpio_output_options_set(SCL_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, SCL_PIN);

    rcu_periph_clock_enable(SDA_RCU);
    gpio_mode_set(SDA_PORT, GPIO_MODE_OUTPUT, GPIO_PUPD_PULLUP, SDA_PIN);
    gpio_output_options_set(SDA_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, SDA_PIN);
}
// ????IIC??????
void CT_IIC_Start(void)
{
    CT_SDA_OUT(); // sda?????
    SDA_ON;
    SCL_ON; // SCL=1???SDA??1??0????
    touch_delay_1us(30);
    SDA_OFF; // START:when CLK is high,DATA change form high to low
    CT_Delay();
    SCL_OFF; // ??I2C????????????????????
}
// ????IIC?????
void CT_IIC_Stop(void)
{
    CT_SDA_OUT(); // sda?????
    SCL_ON;       // SCL=1???SDA??0??1????
    touch_delay_1us(30);
    SDA_OFF; // STOP:when CLK is high DATA change form low to high
    CT_Delay();
    SDA_ON; // ????I2C??????????
}
// ????????????
// ???????1????????????
//         0???????????
uint8_t CT_IIC_Wait_Ack(void)
{
    uint8_t ucErrTime = 0;
    CT_SDA_IN(); // SDA?????????
    SDA_ON;
    SCL_ON;
    CT_Delay();
    while (CT_READ_SDA)
    {
        ucErrTime++;
        if (ucErrTime > 250)
        {
            CT_IIC_Stop();
            return 1;
        }
        CT_Delay();
    }
    SCL_OFF; // ??????0
    return 0;
}
// ????ACK???
void CT_IIC_Ack(void)
{
    SCL_OFF;
    CT_SDA_OUT();
    CT_Delay();
    SDA_OFF;
    CT_Delay();
    SCL_ON;
    CT_Delay();
    SCL_OFF;
}
// ??????ACK???
void CT_IIC_NAck(void)
{
    SCL_OFF;
    CT_SDA_OUT();
    CT_Delay();
    SDA_ON;
    CT_Delay();
    SCL_ON;
    CT_Delay();
    SCL_OFF;
}
// IIC??????????
// ?????????????
// 1???????
// 0???????
void CT_IIC_Send_Byte(uint8_t txd)
{
    uint8_t t;
    CT_SDA_OUT();
    SCL_OFF; // ????????????????
    CT_Delay();
    for (t = 0; t < 8; t++)
    {
        // CT_IIC_SDA=(txd&0x80)>>7;
        // CT_IIC_SDA((txd&0x80)>>7);
        if ((txd & 0x80) >> 7)
        {
            gpio_bit_set(SDA_PORT, SDA_PIN);
        }
        else
        {
            gpio_bit_reset(SDA_PORT, SDA_PIN);
        }

        txd <<= 1;
        SCL_ON;
        CT_Delay();
        SCL_OFF;
        CT_Delay();
    }
}
// ??1??????ack=1???????ACK??ack=0??????nACK
uint8_t CT_IIC_Read_Byte(unsigned char ack)
{
    volatile uint8_t i, receive = 0;
    CT_SDA_IN(); // SDA?????????
    touch_delay_1us(30);
    for (i = 0; i < 8; i++)
    {
        SCL_OFF;
        CT_Delay();
        SCL_ON;
        receive <<= 1;

        // printf("%d ",CT_READ_SDA);
        if (CT_READ_SDA)
            receive++;
    }
    // printf("\r\n receive:%0x \r\n",receive);

    if (!ack)
        CT_IIC_NAck(); // ????nACK
    else
        CT_IIC_Ack(); // ????ACK
    return receive;
}

// ??FT5206§Õ?????????
uint8_t FT5206_WR_Reg(uint16_t reg, uint8_t *buf, uint8_t len)
{
    uint8_t i;
    uint8_t ret = 0;
    CT_IIC_Start();
    CT_IIC_Send_Byte(FT_CMD_WR); // ????§Õ????
    CT_IIC_Wait_Ack();
    CT_IIC_Send_Byte(reg & 0XFF); // ?????8¦Ë???
    CT_IIC_Wait_Ack();
    for (i = 0; i < len; i++)
    {
        CT_IIC_Send_Byte(buf[i]); // ??????
        ret = CT_IIC_Wait_Ack();
        if (ret)
            break;
    }
    CT_IIC_Stop(); // ?????????????
    return ret;
}

// ??FT5206???????????
void FT5206_RD_Reg(uint16_t reg, uint8_t *buf, uint8_t len)
{
    uint8_t i;
    CT_IIC_Start();
    CT_IIC_Send_Byte(FT_CMD_WR); // ????§Õ????
    CT_IIC_Wait_Ack();
    CT_IIC_Send_Byte(reg & 0XFF); // ?????8¦Ë???
    CT_IIC_Wait_Ack();
    CT_IIC_Start();
    CT_IIC_Send_Byte(FT_CMD_RD); // ?????????
    CT_IIC_Wait_Ack();
    for (i = 0; i < len; i++)
    {
        buf[i] = CT_IIC_Read_Byte(i == (len - 1) ? 0 : 1); // ??????
    }
    CT_IIC_Stop(); // ?????????????
}

// ?????FT5206??????
uint8_t FT5206_Init(void)
{
    uint8_t temp[5];
    // PD11?????????????(INT)
    /* enable the led clock */
    rcu_periph_clock_enable(INT_RCU);
    /* configure led GPIO port */
    gpio_mode_set(INT_PORT, GPIO_MODE_INPUT, GPIO_PUPD_NONE, INT_PIN);

    // ?????????????I2C????
    CT_IIC_Init();

    FT5206_WR_Reg(FT_DEVIDE_MODE, temp, 1);  // ??????????????
    FT5206_WR_Reg(FT_ID_G_MODE, temp, 1);    // ?????
    temp[0] = 22;                            // ??????§¹???22???§³?????
    FT5206_WR_Reg(FT_ID_G_THGROUP, temp, 1); // ?????????§¹?
    temp[0] = 12;                            // ?????????????§³??12?????14
    FT5206_WR_Reg(FT_ID_G_PERIODACTIVE, temp, 1);
    // ????·Ú????¦Ï????0x3003
    FT5206_RD_Reg(FT_ID_G_LIB_VERSION, &temp[0], 2);
    printf("CTP ID:%x\r\n", ((uint16_t)temp[0] << 8) + temp[1]);
    return 0;
}

// ??°Ü????(???¨°?????)
// mode:0,???????.
// ?????:?????????.
// 0,?????????;1,?????§Õ???
uint8_t FT5206_Scan(uint8_t mode)
{
    uint8_t buf[4];
    uint8_t i = 0;
    uint8_t res = 0;
    uint8_t temp;
    uint16_t tempsta;
    static uint8_t t = 0; // ?????????,???????CPU?????
    t++;
    if ((t % 10) == 0 || t < 10) // ?????,?????10??CTP_Scan????????1??,??????CPU?????
    {
        FT5206_RD_Reg(FT_REG_NUM_FINGER, &mode, 1); // ????????????
        if ((mode & 0XF) && ((mode & 0XF) <= g_gt_tnum))
        {
            temp = 0XFF << (mode & 0XF); // ????????????1??¦Ë??,???tp_dev.sta????
            tempsta = tp_dev.sta;        // ???›Ì???tp_dev.sta?
            tp_dev.sta = (~temp) | TP_PRES_DOWN | TP_CATH_PRES;
            tp_dev.x[g_gt_tnum - 1] = tp_dev.x[0]; // ???½ò??0??????,??????????????
            tp_dev.y[g_gt_tnum - 1] = tp_dev.y[0];
            // delay_1ms(4);    //??????????????????????§Ñ???????
            for (i = 0; i < g_gt_tnum; i++)
            {
                if (tp_dev.sta & (1 << i)) // ??????§¹?
                {
                    FT5206_RD_Reg(FT5206_TPX_TBL[i], buf, 4); // ???XY?????
                    if (tp_dev.touchtype & 0X01)              // ????
                    {
                        tp_dev.y[i] = ((uint16_t)(buf[0] & 0X0F) << 8) + buf[1];
                        tp_dev.x[i] = ((uint16_t)(buf[2] & 0X0F) << 8) + buf[3];
                    }
                    else
                    {
                        tp_dev.x[i] = (((uint16_t)(buf[0] & 0X0F) << 8) + buf[1]);
                        tp_dev.y[i] = ((uint16_t)(buf[2] & 0X0F) << 8) + buf[3];
                    }
                }
            }
            res = 1;
            if (tp_dev.x[0] > ACTIVE_WIDTH || tp_dev.y[0] > ACTIVE_HEIGHT) // ???????(????????)
            {
                if ((mode & 0XF) > 1) // ??????????????,?????????????????????????.
                {
                    tp_dev.x[0] = tp_dev.x[1];
                    tp_dev.y[0] = tp_dev.y[1];
                    t = 0; // ???????,??????????????10??,????????????
                }
                else // ???????,???????????(????????)
                {
                    tp_dev.x[0] = tp_dev.x[g_gt_tnum - 1];
                    tp_dev.y[0] = tp_dev.y[g_gt_tnum - 1];
                    mode = 0X80;
                    tp_dev.sta = tempsta; // ???tp_dev.sta
                }
            }
            else
                t = 0; // ???????,??????????????10??,????????????
        }
    }

    if ((mode & 0X1F) == 0) // ?????????
    {
        if (tp_dev.sta & TP_PRES_DOWN) // ??????????
        {
            tp_dev.sta &= ~TP_PRES_DOWN; // ?????????
        }
        else // ??????§Ò?????
        {
            tp_dev.x[0] = 0xffff;
            tp_dev.y[0] = 0xffff;
            tp_dev.sta &= 0XE0; // ???????§¹???
        }
    }

    if (t > 240)
        t = 10; // ?????10???????
    return res;
}

/**********************************************************
 * ?? ?? ?? ???letgo_scan
 * ?? ?? ?? ????????????§Ø?
 * ?? ?? ?? ????contact???????????(?????5??????)
 * 				(sx,sy)???§Ø??????????????
 * 				(ex,ey)???§Ø??????????????
 * ?? ?? ?? ?????
 * ??       ???LCKFB
 * ??       ?????
**********************************************************/
void letgo_scan(uint16_t contact,uint16_t sx, uint16_t sy,uint16_t ex, uint16_t ey)
{	
	//???????
	while( FT5206_Scan(0) )
	{
		//???????x??????¦¶
		if( tp_dev.x[contact] <= sx || tp_dev.x[contact] >= ex )
		{
			return;
		}
		//???????y??????¦¶
		if( tp_dev.y[contact] <= sy && tp_dev.y[contact] >= ey )
		{
			return;
		}
	}
}
